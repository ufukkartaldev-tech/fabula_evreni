rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isValidString(text, minLen, maxLen) {
      return text is string && text.size() >= minLen && text.size() <= maxLen;
    }
    
    function isValidTimestamp(timestamp) {
      return timestamp is timestamp;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles
      allow read: if true;
      
      // Only the user can create/update their own profile
      allow create: if isOwner(userId) 
        && isValidString(request.resource.data.displayName, 1, 50)
        && request.resource.data.totalWins >= 0
        && request.resource.data.currentBadge is string;
      
      allow update: if isOwner(userId)
        && isValidString(request.resource.data.displayName, 1, 50)
        && request.resource.data.totalWins >= 0;
      
      // Users cannot delete their profiles (soft delete should be handled in app)
      allow delete: if false;
    }
    
    // Stories collection
    match /stories/{storyId} {
      // Anyone can read stories
      allow read: if true;
      
      // Authenticated users can create stories
      allow create: if isSignedIn()
        && isValidString(request.resource.data.title, 3, 200)
        && isValidString(request.resource.data.content, 10, 50000)
        && isValidString(request.resource.data.excerpt, 10, 500)
        && isValidString(request.resource.data.category, 2, 50)
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.stats.views == 0
        && request.resource.data.stats.comments == 0
        && request.resource.data.stats.likes == 0;
      
      // Only the author can update their own stories
      allow update: if isOwner(resource.data.authorId)
        && isValidString(request.resource.data.title, 3, 200)
        && isValidString(request.resource.data.content, 10, 50000);
      
      // Only the author can delete their stories
      allow delete: if isOwner(resource.data.authorId);
    }
    
    // Comments collection
    match /comments/{commentId} {
      // Anyone can read comments
      allow read: if true;
      
      // Authenticated users can create comments
      allow create: if isSignedIn()
        && isValidString(request.resource.data.content, 1, 2000)
        && isValidString(request.resource.data.storyId, 1, 100)
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.likes == 0;
      
      // Only the author can update their own comments
      allow update: if isOwner(resource.data.userId)
        && isValidString(request.resource.data.content, 1, 2000);
      
      // Only the author can delete their comments
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Likes collection (for tracking who liked what)
    match /likes/{likeId} {
      // Anyone can read likes
      allow read: if true;
      
      // Users can only create likes for themselves
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && isValidString(request.resource.data.targetId, 1, 100)
        && request.resource.data.targetType in ['story', 'comment'];
      
      // Users can only delete their own likes
      allow delete: if isOwner(resource.data.userId);
      
      // Likes cannot be updated
      allow update: if false;
    }
    
    // Favorites collection
    match /favorites/{favoriteId} {
      // Users can only read their own favorites
      allow read: if isOwner(resource.data.userId);
      
      // Users can only create favorites for themselves
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && isValidString(request.resource.data.storyId, 1, 100);
      
      // Users can only delete their own favorites
      allow delete: if isOwner(resource.data.userId);
      
      // Favorites cannot be updated
      allow update: if false;
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isOwner(resource.data.userId);
      
      // Allow authenticated users to create notifications
      allow create: if isSignedIn();
      
      // Users can mark their own notifications as read
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.keys().hasOnly(['read'])
        && request.resource.data.read is bool;
      
      // Users can delete their own notifications
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Drafts collection
    match /drafts/{draftId} {
      // Users can only read their own drafts
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Users can create drafts for themselves
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && isValidString(request.resource.data.title, 1, 200)
        && isValidString(request.resource.data.content, 1, 50000);
      
      // Users can update their own drafts
      allow update: if isOwner(resource.data.userId);
      
      // Users can delete their own drafts
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Follows collection
    match /follows/{followId} {
      // Anyone can read follows (for public follower/following lists)
      allow read: if true;
      
      // Users can create follows for themselves
      allow create: if isSignedIn()
        && request.resource.data.followerId == request.auth.uid;
      
      // Users can delete their own follows
      allow delete: if isSignedIn()
        && resource.data.followerId == request.auth.uid;
      
      // Follows cannot be updated
      allow update: if false;
    }
    
    // Leaderboard collection (read-only for users)
    match /leaderboard/{userId} {
      allow read: if true;
      allow write: if false; // Only updated by Cloud Functions or admin SDK
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
